<div id="taskManagerScreen" class="screen">
            <h2 style="text-align: left;">‚úÖ Mis Asignaciones (Todoist-like)</h2>
            <div class="mb-6 p-4 bg-gray-100 rounded-lg">
                <input type="text" id="newTaskText" placeholder="Nueva tarea o asignaci√≥n (Ej: 'Hacer el resumen de Historia')" class="subject-select">
                
                <div class="flex items-center subject-select p-0" style="border: none; margin: 10px 0;">
                    <span class="text-gray-500 text-base mr-3" style="padding-left: 15px;">üìÖ Fecha L√≠mite:</span>
                    <input type="date" id="newTaskDeadline" class="flex-grow" placeholder="Seleccionar fecha" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box;">
                </div>
                <button onclick="addTask()" class="main-button" style="background-color: #007bff; padding: 10px;">A√±adir Tarea</button>
            </div>
            ```

### Explicaci√≥n del Arreglo:

* **Hemos movido la fecha a un `div` con la clase `flex`:** Esto nos permite alinear elementos f√°cilmente.
* **A√±adimos `üìÖ Fecha L√≠mite:`:** Este texto (y emoji) es ahora una etiqueta permanente y clara que indica la funci√≥n del campo siguiente, independientemente de c√≥mo iOS renderice el `input` de fecha.
* **A√±adimos `placeholder="Seleccionar fecha"`:** Esto refuerza el mensaje en caso de que el navegador lo muestre.
* **Ajuste de estilos:** Desactivamos el estilo `subject-select` en el `div` contenedor para aplicarlo solo al `input` de la fecha y mantener la consistencia visual.

Este cambio garantiza que el usuario en cualquier dispositivo sabr√° qu√© hacer con el campo de fecha.

---

## üíª C√≥digo HTML y JavaScript COMPLETO Y ARREGLADO (v2)

Aqu√≠ tienes el c√≥digo completo con la correcci√≥n aplicada en el gestor de tareas:

```html
<!DOCTYPE html>
<html>
<head>
    <title>CarlaMaths App - 1¬∫ESO (TDA Enhancements)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =================================================================== */
        /* ESTILOS CSS INCLUIDOS DIRECTAMENTE */
        /* =================================================================== */
        body {
            font-family: 'Inter', Arial, sans-serif; 
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
            text-align: center;
            touch-action: pan-y;
        }
        .screen {
            display: none;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 10px; 
            text-align: left;
        }
        .screen.active {
            display: block;
        }
        h2 {
            font-size: 1.8em;
            color: #4a7d4a; 
            margin-bottom: 20px;
            text-align: center;
        }
        #exerciseScreen { background-color: #e6ffe6; text-align: center; } 
        .question-box {
            background-color: #fff;
            border: 2px solid #5cb85c;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .options button, .main-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            background-color: #a4e4a4; 
            color: #333; 
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: 600;
        }
        .main-button {
            background-color: #5cb85c; 
            color: white;
            box-shadow: 0 3px #3c8d3c;
        }
        .main-button:active {
            transform: translateY(2px);
            box-shadow: 0 1px #3c8d3c;
        }
        .options button:hover:not(:disabled) {
            background-color: #79d279; 
        }
        .options button.correct {
            background-color: #28a745; 
            color: white; 
            font-weight: bold;
        }
        .options button.wrong {
            background-color: #f17b7b; 
            color: #333; 
        }
        .options button:disabled {
            opacity: 0.7;
            cursor: default;
        }
        
        .gamification {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            border-bottom: 2px solid #ccc;
        }
        .progress-bar-container {
            width: 50%;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin: 0 10px;
            height: 20px;
        }
        #progress {
            height: 100%;
            width: 0%;
            background-color: #ffc107; 
            transition: width 0.5s;
        }
        .medal {
            font-size: 1.5em;
            opacity: 0.3;
        }
        .medal.active {
            opacity: 1;
        }
        .reward-banner {
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 10;
            position: relative;
        }
        .subject-select {
            display: block; 
            width: 100%; 
            padding: 10px 15px; 
            margin: 10px 0; 
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box; 
        }
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-left: 5px solid #007bff; 
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .task-item.completed {
            background-color: #e0f7e0;
            border-left: 5px solid #28a745;
            text-decoration: line-through;
            opacity: 0.8;
        }
        .task-actions button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.2em;
        }
        .task-actions .delete-btn { color: #dc3545; }
        .task-actions .complete-btn { color: #28a745; }
        #scheduleContainer {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .schedule-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #fff0d6; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid #ff9800;
        }
        .slot-time {
            font-weight: bold;
            color: #ff9800;
            width: 30%;
        }
        .slot-activity {
            flex-grow: 1;
            text-align: left;
        }
        /* Estilos para el modal de mensaje */
        #customMessageModal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        .modal-content p { margin-bottom: 20px; }
        /* Estilos para el contenedor de juegos */
        .game-container {
            display: none; /* Ocultar por defecto */
            text-align: center;
            margin-top: 20px;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .game-container.active {
            display: block; /* Mostrar solo el activo */
        }
        .game-container iframe {
            width: 100%; 
            height: 400px; /* Tama√±o fijo para el placeholder */
            border: 0;
            border-radius: 5px;
            margin-top: 10px;
        }
        @media (max-width: 768px) {
            .screen {
                padding: 10px;
                box-shadow: none;
                border-radius: 0;
            }
            .gamification {
                flex-direction: column;
                gap: 5px;
            }
            .progress-bar-container {
                width: 100%;
                margin: 5px 0;
            }
            .task-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            .task-details {
                margin-bottom: 5px;
            }
        }
    </style>
    <script>
        // La configuraci√≥n REAL de tu proyecto. ¬°DEBES REEMPLAZAR ESTO!
        window.__firebase_config = JSON.stringify({
            "apiKey": "AIzaSyA2_vhF-3qbOEBB20B4t4fvAn8iBSNd6aE", 
            "authDomain": "app-de-karla-b21a1.firebaseapp.com",
            "projectId": "app-de-karla-b21a1",
            "storageBucket": "app-de-karla-b21a1.firebasestorage.app",
            "messagingSenderId": "922949533120",
            "appId": "1:922949533120:web:22562633843a07d40e1c25",
            "measurementId": "G-VXRF7BXCBX"
        });
        
        // El ID de la aplicaci√≥n para las rutas de Firestore
        window.__app_id = 'app-de-karla-b21a1';
        
        // Token inicial (null para autenticaci√≥n an√≥nima)
        window.__initial_auth_token = null; 
    </script>
    
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, deleteDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACI√ìN DE FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {}; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.isAuthReady = false;
        window.userId = null;

        // --- DEFINICI√ìN DE RUTAS (Collections) ---
        window.getStudyDataPath = () => doc(window.db, `artifacts/${appId}/users/${window.userId}/study_data`, 'current_stats');
        window.getTasksCollection = () => collection(window.db, `artifacts/${appId}/users/${window.userId}/tasks`);
        window.getRoutineDataPath = () => doc(window.db, `artifacts/${appId}/users/${window.userId}/routine_data`, 'daily_schedule');

        // --- FUNCIONES DE PERSISTENCIA (Mantenidas dentro del m√≥dulo para acceder a las importaciones) ---

        // Funci√≥n de utilidad para mostrar mensajes (Necesaria aqu√≠ para usarla en las funciones de persistencia)
        function showCustomMessage(message, type = 'error') {
            const modal = document.getElementById('customMessageModal');
            const messageText = document.getElementById('customMessageText');
            const colorMap = {
                error: '#dc3545',
                info: '#007bff',
                success: '#28a745',
                warning: '#ffc107'
            };
            messageText.innerText = message;
            modal.querySelector('.modal-content').style.border = `2px solid ${colorMap[type] || colorMap.error}`;
            modal.style.display = 'block';
        }
        
        async function loadStudyData() {
            if (!window.isAuthReady || !window.userId) return;
            try {
                const docRef = window.getStudyDataPath();
                const docSnap = await getDoc(docRef); 

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.points = data.points || 0; 
                    window.level = data.level || 1; 
                    updatePoints();
                    updateLevel(); 
                    updateMedals(); 
                }
            } catch (e) {
                console.error("Error al cargar datos de estudio:", e);
            } finally {
                document.getElementById('sessionUserId').innerText = window.userId || 'No disponible';
                document.getElementById('loadingTasks').innerText = 'A√±ade tus tareas para empezar.';
            }
        }
        
        async function saveStudyData() {
            if (!window.isAuthReady || !window.userId) return;
            try {
                const docRef = window.getStudyDataPath();
                await setDoc(docRef, { 
                    points: window.points, 
                    level: window.level, 
                    last_update: new Date().toISOString() 
                }, { merge: true });
            } catch (e) {
                console.error("Error al guardar datos de estudio:", e);
            }
        }

        async function loadTasks() {
            if (!window.isAuthReady || !window.userId) return;
            const tasksCol = window.getTasksCollection();
            const q = query(tasksCol, orderBy("completed", "asc"), orderBy("deadline", "asc")); 
            onSnapshot(q, (snapshot) => {
                window.currentTasks = []; 
                snapshot.forEach(doc => {
                    const data = doc.data();
                    window.currentTasks.push({ 
                        id: doc.id,
                        text: data.text,
                        deadline: data.deadline,
                        completed: data.completed
                    });
                });
                renderTasks();
            }, (error) => {
                console.error("Error al escuchar las tareas:", error);
                document.getElementById('loadingTasks').innerText = 'Error al cargar tareas.';
            });
        }

        async function addTask() {
            if (!window.isAuthReady || !window.userId) {
                showCustomMessage('Espera a que la sesi√≥n est√© lista para a√±adir tareas.', 'info');
                return;
            }
            const text = document.getElementById('newTaskText').value.trim();
            const deadline = document.getElementById('newTaskDeadline').value; 
            if (!text) {
                showCustomMessage('El texto de la tarea no puede estar vac√≠o.', 'error');
                return;
            }
            try {
                const tasksCol = window.getTasksCollection();
                await addDoc(tasksCol, { 
                    text: text,
                    deadline: deadline, 
                    completed: false,
                    createdAt: new Date().toISOString() 
                });
                document.getElementById('newTaskText').value = '';
                document.getElementById('newTaskDeadline').value = '';
                showCustomMessage('Tarea a√±adida con √©xito.', 'success');
            } catch (e) {
                console.error("Error al a√±adir tarea:", e);
                showCustomMessage('Error al a√±adir tarea.', 'error');
            }
        }

        async function toggleTaskCompletion(taskId, completedStatus) {
            if (!window.isAuthReady || !window.userId) return;
            try {
                const taskRef = doc(window.getTasksCollection(), taskId);
                await updateDoc(taskRef, { completed: completedStatus }); 
            } catch (e) {
                console.error("Error al actualizar tarea:", e);
                showCustomMessage('Error al actualizar tarea.', 'error');
            }
        }

        async function deleteTask(taskId) {
            if (!window.isAuthReady || !window.userId) return;
            try {
                const taskRef = doc(window.getTasksCollection(), taskId);
                await deleteDoc(taskRef); 
            } catch (e) {
                console.error("Error al eliminar tarea:", e);
                showCustomMessage('Error al eliminar tarea.', 'error');
            }
        }

        async function loadRoutineFromDB() {
            if (!window.isAuthReady || !window.userId) return;
            try {
                const docRef = window.getRoutineDataPath();
                const docSnap = await getDoc(docRef); 

                if (docSnap.exists()) {
                    window.currentRoutine = docSnap.data().schedule || []; 
                } else {
                    window.currentRoutine = []; 
                }
                renderRoutine();
            } catch (e) {
                console.error("Error al cargar rutina:", e);
                document.getElementById('loadingRoutine').innerText = 'Error al cargar rutina.';
            }
        }
        
        async function saveRoutine() {
            // 1. COMPROBACI√ìN INICIAL: Si la sesi√≥n no est√° lista, avisa y espera.
            if (!window.isAuthReady || !window.userId) {
                showCustomMessage('Cargando sesi√≥n... Espera un momento antes de guardar.', 'info');
                
                // PAUSA CLAVE: Damos 1.5 segundos a Firebase para terminar la autenticaci√≥n an√≥nima
                await new Promise(resolve => setTimeout(resolve, 1500)); 
                
                // 2. COMPROBACI√ìN FINAL: Si sigue sin estar listo despu√©s de esperar, aborta.
                if (!window.isAuthReady || !window.userId) {
                     showCustomMessage('Sesi√≥n no lista. No se puede guardar. (Revisa tu conexi√≥n o la Autenticaci√≥n An√≥nima en Firebase).', 'error');
                     return;
                }
            }
            
            // 3. INTENTO DE GUARDAR
            try {
                const docRef = window.getRoutineDataPath();
                await setDoc(docRef, { schedule: window.currentRoutine }); 
                showCustomMessage('Rutina diaria guardada con √©xito.', 'success');
            } catch (e) {
                console.error("Error al guardar rutina:", e);
                
                // 4. DIAGN√ìSTICO DE ERROR (Especialmente 'permission-denied')
                if (e.code === 'permission-denied') {
                    showCustomMessage('Error de permiso: Revisa las Reglas de Seguridad de Firestore. Necesitan permitir escribir a usuarios autenticados.', 'error');
                } else {
                    showCustomMessage('Error al guardar rutina.', 'error');
                }
            }
        }

        // --- FUNCI√ìN PRINCIPAL DE AUTENTICACI√ìN ---
        async function initializeAuthAndFirestore() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        window.isAuthReady = true;

                        // Llamadas de carga
                        loadStudyData(); 
                        loadTasks(); 
                        loadRoutineFromDB(); 
                        
                        // Estas funciones se definen globalmente m√°s abajo en el script principal
                        if (typeof hideAllScreens === 'function') hideAllScreens();
                        if (document.getElementById('subjectScreen')) document.getElementById('subjectScreen').classList.add('active'); 
                        
                    } else {
                        window.userId = null;
                        window.isAuthReady = true; 
                        showCustomMessage('Sesi√≥n no iniciada. Usando modo an√≥nimo. Tu progreso no se guardar√°.', 'info');
                        document.getElementById('sessionUserId').innerText = 'AN√ìNIMO';
                        if (typeof hideAllScreens === 'function') hideAllScreens();
                        if (document.getElementById('loginScreen')) document.getElementById('loginScreen').classList.add('active'); 
                    }
                });
            } catch (error) {
                console.error("Error CR√çTICO en la autenticaci√≥n:", error);
                showCustomMessage('Error al iniciar sesi√≥n. ¬°Verifica la API Key y la Autenticaci√≥n An√≥nima!', 'error');
                
                if (typeof hideAllScreens === 'function') hideAllScreens();
                if (document.getElementById('subjectScreen')) document.getElementById('subjectScreen').classList.add('active');
            }
        }

        // Hacemos las funciones necesarias accesibles globalmente (solo las que se llaman desde el HTML)
        window.showCustomMessage = showCustomMessage;
        window.deleteTask = deleteTask;
        window.toggleTaskCompletion = toggleTaskCompletion;
        window.loadRoutineFromDB = loadRoutineFromDB;
        window.addTask = addTask;
        window.saveRoutine = saveRoutine;
        window.saveStudyData = saveStudyData; // Necesaria para el updateLevel

        
        // Inicializar la autenticaci√≥n
        initializeAuthAndFirestore(); 
        
        // Listener de DOMContentLoaded se mantiene
        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('subjectChoose').addEventListener('change', populateEvaluations);
             document.getElementById('evaluationChoose').addEventListener('change', populateTopics);
        });

    </script>
</head>
<body>

    <div id="loginScreen" class="screen">
        <h2>Bienvenido, Alex üëã</h2>
        <p>¬°Vamos a repasar 1¬∫ESO jugando!</p>
        <input type="text" id="studentNameLogin" placeholder="Tu Nombre" style="padding: 10px; margin: 10px 0; width: 80%; border-radius: 5px; border: 1px solid #ccc;">
        <input type="number" id="studentAgeLogin" placeholder="Tu Edad" style="padding: 10px; margin: 10px 0; width: 80%; border-radius: 5px; border: 1px solid #ccc;">
        <button onclick="hideAllScreens(); document.getElementById('subjectScreen').classList.add('active');" class="main-button">Entrar a la App</button> 
        <p class="text-xs text-gray-500 mt-4 text-center">ID de Sesi√≥n: <span id="sessionUserId">Cargando...</span></p>
        <p class="text-xs text-gray-500 mt-2 text-center">Guarda este ID para compartir tu progreso.</p>
    </div>
    
    <div id="subjectScreen" class="screen active"> 
        <h2>Men√∫ de Estudio</h2>
        <div class="mb-4">
            <button onclick="showScreen('exerciseScreen'); loadQuestion()" class="main-button" style="background-color: #5cb85c;">üöÄ Empezar a Estudiar</button>
            <button onclick="showScreen('taskManagerScreen')" class="main-button" style="background-color: #007bff; box-shadow: 0 3px #0056b3;">‚úÖ Mi Gestor de Tareas (Todoist)</button>
            <button onclick="showScreen('visualPlannerScreen'); loadRoutineFromDB();" class="main-button" style="background-color: #ff9800; box-shadow: 0 3px #e68a00;">üìÖ Mi Rutina Diaria (Tiimo)</button>
            <button onclick="showScreen('reviewScreen')" class="main-button" style="background-color: #6c757d; box-shadow: 0 3px #545b62;">üìà Revisar Progreso</button>
        </div>

        <h3>Selecciona tu Tema</h3>
        <select id="subjectChoose" class="subject-select">
            <option value="" disabled selected>-- Elige Asignatura --</option>
            <option value="Matem√°ticas">Matem√°ticas</option>
            <option value="Lengua">Lengua</option>
            <option value="Sociales">Sociales</option>
        </select>

        <select id="evaluationChoose" class="subject-select">
            <option value="">--Selecciona Evaluaci√≥n--</option>
        </select>

        <select id="topicChoose" class="subject-select">
            <option value="">--Selecciona Tema--</option>
        </option>
        </select>

        <button onclick="startExercises()" class="main-button" style="background-color: #28a745;">Cargar Ejercicios</button>
    </div>

    <div id="exerciseScreen" class="screen">
        <div class="gamification">
            <span id="levelDisplay">Nivel: 1</span>
            <div class="progress-bar-container"><div id="progress"></div></div>
            <span id="pointsDisplay">Puntos: 0</span>
            <div id="medals"></div>
        </div>
        
        <p>Est√°s estudiando: <strong id="subjectTopic"></strong></p>
        <p>Pregunta <span id="questionNumber">1</span> de <span id="totalQuestions">20</span></p>

        <div class="question-box">
            <p id="questionText">Cargando pregunta...</p>
        </div>
        
        <div class="options" onclick="handleOptionClick(event)">
            <button data-option-index="0"></button>
            <button data-option-index="1"></button>
            <button data-option-index="2"></button>
            <button data-option-index="3"></button>
        </div>

        <button onclick="nextQuestion()" class="main-button">Siguiente Pregunta</button>
        <button onclick="goToReview()" class="main-button" style="background-color: #6c757d;">Terminar Sesi√≥n (Revisar)</button>
    </div>

    <div id="taskManagerScreen" class="screen">
        <h2 style="text-align: left;">‚úÖ Mis Asignaciones (Todoist-like)</h2>
        <div class="mb-6 p-4 bg-gray-100 rounded-lg">
            <input type="text" id="newTaskText" placeholder="Nueva tarea o asignaci√≥n (Ej: 'Hacer el resumen de Historia')" class="subject-select">
            
            <div class="flex items-center subject-select p-0" style="border: 1px solid #ccc; background-color: white;">
                <span class="text-gray-500 text-base mr-3" style="padding: 10px 15px;">üìÖ Fecha L√≠mite:</span>
                <input type="date" id="newTaskDeadline" class="flex-grow" placeholder="Seleccionar fecha" style="padding: 10px; border: none; border-radius: 0 5px 5px 0; width: 100%; box-sizing: border-box;">
            </div>
            <button onclick="addTask()" class="main-button" style="background-color: #007bff; padding: 10px;">A√±adir Tarea</button>
        </div>

        <div id="taskList" class="flex flex-col gap-2">
            <p class="text-center text-gray-500" id="loadingTasks">Cargando tareas...</p>
        </div>

        <button onclick="showScreen('subjectScreen')" class="main-button mt-6" style="background-color: #333;">Volver al Men√∫</button>
    </div>
    
    <div id="visualPlannerScreen" class="screen">
        <h2 style="text-align: left;">üìÖ Mi Rutina Diaria (Tiimo-like)</h2>

        <div class="mb-6 p-4 bg-gray-100 rounded-lg">
            <p class="text-sm text-gray-600 mb-2">Define tu d√≠a: qu√© hacer y cu√°nto tiempo.</p>
            <input type="time" id="routineStartTime" value="09:00" class="subject-select inline-block w-1/2 pr-1" style="width: 49%; padding-right: 0;">
            <input type="text" id="routineActivity" placeholder="Actividad (Ej: 'Estudio de Matem√°ticas')" class="subject-select">
            <select id="routineDuration" class="subject-select">
                <option value="15">15 minutos</option>
                <option value="30">30 minutos</option>
                <option value="45">45 minutos</option>
                <option value="60" selected>1 hora (60 minutos)</option>
                <option value="90">1 hora y media</option>
            </select>
            <button onclick="addRoutineSlot()" class="main-button" style="background-color: #ff9800; padding: 10px;">A√±adir Bloque</button>
            <button onclick="saveRoutine()" class="main-button" style="background-color: #ff6f00; padding: 10px;">Guardar Rutina</button>
        </div>

        <h3>Tu Horario Visual</h3>
        <div id="scheduleContainer">
            <p class="text-center text-gray-500" id="loadingRoutine">A√±ade bloques de actividad.</p>
        </div>

        <button onclick="showScreen('subjectScreen')" class="main-button mt-6" style="background-color: #333;">Volver al Men√∫</button>
    </div>


    <div id="reviewScreen" class="screen">
        <h2 style="text-align: center;">üìà Resumen de la Sesi√≥n</h2>
        <div class="p-4 bg-yellow-100 rounded-lg mb-6 text-center">
            <p class="text-lg font-bold text-yellow-800">Puntos Totales: <span id="finalPoints" class="text-2xl">0</span></p>
            <p class="text-lg font-bold text-yellow-800">Nivel Alcanzado: <span id="finalLevel" class="text-2xl">1</span></p>
        </div>
        
        <h3>Ejercicios Acertados:</h3>
        <div id="reviewQuestions" class="mt-4 p-4 border rounded-lg bg-gray-50">
        </div>

        <button onclick="goToSubjectFromExercise()" class="main-button mt-6" style="background-color: #5cb85c;">Volver al Men√∫</button>
    </div>

    <div id="gameScreen" class="screen">
        <div id="rewardMessage" class="reward-banner" style="display: none;">
            <h2>¬°FELICIDADES, Alex! ¬°PREMIO! üéâ</h2>
            <p>Has subido al Nivel <span id="rewardLevel"></span>. T√≥mate un descanso y ¬°a jugar!</p>
        </div>

        <div id="arkanoidGameContainer" class="game-container"> 
            <h2>ArKanoid T√°ctil</h2> 
            <iframe id="iframe_arkanoid" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div> 
        <div id="memoriaGameContainer" class="game-container"> 
            <h2>Juego de Pares</h2> 
            <iframe id="iframe_memoria" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div>
        <div id="matamarcianosGameContainer" class="game-container"> 
            <h2>Matamarcianos</h2> 
            <iframe id="iframe_matamarcianos" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div>
        <div id="asteroidesGameContainer" class="game-container"> 
            <h2>Juego de Asteroides</h2> 
            <iframe id="iframe_asteroides" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div>
        <div id="donkeykongGameContainer" class="game-container"> 
            <h2>Donkeykong</h2> 
            <iframe id="iframe_donkeykong" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div>
        <div id="froggerGameContainer" class="game-container"> 
            <h2>Juego de la Rana</h2> 
            <iframe id="iframe_frogger" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div>
        <div id="pongGameContainer" class="game-container"> 
            <h2>Tenis (Pong)</h2> 
            <iframe id="iframe_pong" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div>
        <div id="tictactoeGameContainer" class="game-container"> 
            <h2>Tres en Raya</h2> 
            <iframe id="iframe_tictactoe" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div>
        <div id="tetrisGameContainer" class="game-container"> 
            <h2>Tetris Lite</h2> 
            <iframe id="iframe_tetris" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div>
        <div id="pacmanGameContainer" class="game-container"> 
            <h2>Pacman</h2> 
            <iframe id="iframe_pacman" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> 
        </div>
        
        <div style="margin-top: 20px;">
            <button onclick="endGame()" class="main-button" style="background-color: #dc3545;">Volver a los Ejercicios</button>
        </div>
    </div>
    
    <div id="customMessageModal">
        <div class="modal-content">
            <p id="customMessageText"></p>
            <button onclick="hideCustomMessage()" class="main-button" style="background-color: #5cb85c; width: auto; padding: 8px 20px;">Entendido</button>
        </div>
    </div>


    <script>
        // ===================================================================
        // 3. FUNCIONES GLOBALES Y ESTRUCTURA CURRICULAR (RESTO DEL C√ìDIGO JS)
        // ===================================================================
        
        // --- Variables Globales ---
        // Se inicializan en window para ser accesibles desde el m√≥dulo y fuera
        window.currentExercises = [];
        window.currentQ = 0;
        window.points = window.points || 0; // Se cargar√° desde Firebase, pero inicializamos
        window.level = window.level || 1; // Se cargar√° desde Firebase, pero inicializamos
        window.completedExercises = []; 
        window.answeredCurrentQuestion = false;
        window.currentRoutine = [];
        window.currentTasks = [];
        window.animationFrameId = null; 

        // --- Estructura Curricular (Mismo contenido) ---
        const curriculum = {
              "Matem√°ticas": {
                "1¬∫ESO": {
                    "1¬™ evaluaci√≥n": {
                         "N√∫meros y Operaciones": [
                             { q: "¬øC√≥mo se lee 1.345.000?", options: ["Un mill√≥n trescientos cuarenta y cinco mil", "Trece millones", "Ciento treinta y cuatro mil", "Un bill√≥n"], correct: 0 },
                             { q: "¬øQui√©n realiz√≥ la primera vuelta al mundo por mar?", options: ["Crist√≥bal Col√≥n", "Magallanes", "Vasco da Gama", "Hern√°n Cort√©s"], correct: 1 }
                         ]
                    }
                }
            }
        };

        const availableGames = [
            { id: 1, name: "Arkanoid T√°ctil", func: "startGame1_Arkanoid", file: "arkanoid.html", container: "arkanoidGameContainer", iframe: "iframe_arkanoid" },
            { id: 2, name: "Juego de Pares", func: "startGame2_Memoria", file: "memoria.html", container: "memoriaGameContainer", iframe: "iframe_memoria" },
            { id: 3, name: "Matamarcianos", func: "startGame3_Matamarcianos", file: "matamarcianos.html", container: "matamarcianosGameContainer", iframe: "iframe_matamarcianos" },
            { id: 4, name: "Juego de Asteroides", func: "startGame4_Asteroides", file: "asteroides.html", container: "asteroidesGameContainer", iframe: "iframe_asteroides" },
            { id: 5, name: "Donkeykong", func: "startGame5_Donkeykong", file: "donkeykong.html", container: "donkeykongGameContainer", iframe: "iframe_donkeykong" },
            { id: 6, name: "Juego de la Rana", func: "startGame6_Frogger", file: "frogger.html", container: "froggerGameContainer", iframe: "iframe_frogger" },
            { id: 7, name: "Tenis", func: "startGame7_Pong", file: "pong.html", container: "pongGameContainer", iframe: "iframe_pong" },
            { id: 8, name: "Tres en Raya", func: "startGame8_TicTacToe", file: "tictactoe.html", container: "tictactoeGameContainer", iframe: "iframe_tictactoe" },
            { id: 9, name: "Tetris Lite", func: "startGame9_Tetris", file: "tetris.html", container: "tetrisGameContainer", iframe: "iframe_tetris" },
            { id: 10, name: "Pacman", func: "startGame10_Pacman", file: "pacman.html", container: "pacmanGameContainer", iframe: "iframe_pacman" }
        ];

        // --- Funciones de Mensajes ---
        // Nota: showCustomMessage est√° definida en el m√≥dulo, aqu√≠ solo se define hideCustomMessage
        function hideCustomMessage() {
            document.getElementById('customMessageModal').style.display = 'none';
            const modalBtn = document.getElementById('customMessageModal').querySelector('.main-button');
            modalBtn.onclick = hideCustomMessage; 
        }

        // --- Funciones de Navegaci√≥n y Selectores ---
        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        }
        function showScreen(screenId) {
             hideAllScreens();
             document.getElementById(screenId).classList.add('active');
             if (screenId === 'subjectScreen') {
                 populateEvaluations();
             }
        }
        function goToSubjectFromExercise() {
            showScreen('subjectScreen');
        }
        function goToReview() {
            showScreen('reviewScreen');
            updateReviewScreen();
        }
        function populateEvaluations() {
            const subjectChosen = document.getElementById('subjectChoose').value; 
            const evaluationSelect = document.getElementById('evaluationChoose');
            evaluationSelect.innerHTML = '<option value="">--Selecciona Evaluaci√≥n--</option>';
            if (!subjectChosen) {
                populateTopics();
                return;
            }
            const currentCurriculum = curriculum[subjectChosen] ? curriculum[subjectChosen]['1¬∫ESO'] : {};
            Object.keys(currentCurriculum).forEach(evalName => {
                const o = document.createElement('option');
                o.value = evalName;
                o.text = evalName;
                evaluationSelect.add(o);
            });
            populateTopics(); 
        }
        function populateTopics() {
            const subject = document.getElementById('subjectChoose').value;
            const evaluation = document.getElementById('evaluationChoose').value;
            const topicSelect = document.getElementById('topicChoose');
            topicSelect.innerHTML = '<option value="">--Selecciona Tema--</option>';
            if (subject && evaluation && curriculum[subject]["1¬∫ESO"][evaluation]) {
                Object.keys(curriculum[subject]["1¬∫ESO"][evaluation]).forEach(t => {
                    const o = document.createElement('option');
                    o.value = t;
                    o.text = t;
                    topicSelect.add(o);
                });
            }
        }
        function endGame() {
            if (window.animationFrameId) {
                cancelAnimationFrame(window.animationFrameId);
                window.animationFrameId = null;
            }
            document.querySelectorAll('.game-container').forEach(container => {
                container.classList.remove('active');
            });
            document.getElementById('rewardMessage').style.display = 'none'; 
            showScreen('exerciseScreen');
            window.answeredCurrentQuestion = true; 
            nextQuestion(); 
        }

        // --- Funciones de Ejercicio y Gamificaci√≥n ---
        function startExercises() {
            const subject = document.getElementById('subjectChoose').value;
            const evaluation = document.getElementById('evaluationChoose').value;
            const topic = document.getElementById('topicChoose').value;
            if (!subject || !evaluation || !topic) {
                window.showCustomMessage('Selecciona asignatura, evaluaci√≥n y tema', 'error');
                return;
            }
            const original = curriculum[subject]["1¬∫ESO"][evaluation][topic];
            const shuffled = [...original];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            const maxQuestions = 100;
            window.currentExercises = shuffled.slice(0, Math.min(original.length, maxQuestions));
            window.currentQ = 0;
            window.completedExercises = [];
            window.answeredCurrentQuestion = false;
            showScreen('exerciseScreen');
            document.getElementById('subjectTopic').innerText = `${subject} - ${topic}`;
            document.getElementById('totalQuestions').innerText = window.currentExercises.length;
            updatePoints();
            updateLevel();
            updateMedals();
            loadQuestion();
        }
        function loadQuestion() {
            window.answeredCurrentQuestion = false;
            if (window.currentQ >= window.currentExercises.length) {
                return goToReview(); 
            }
            const q = window.currentExercises[window.currentQ];
            document.getElementById('questionNumber').innerText = window.currentQ + 1;
            document.getElementById('questionText').innerText = q.q;
            const btns = document.querySelectorAll('.options button');
            const optionIndexes = [0, 1, 2, 3].sort(() => Math.random() - 0.5); 
            btns.forEach((btn, i) => {
                const originalIndex = optionIndexes[i];
                btn.innerText = q.options[originalIndex];
                btn.setAttribute('data-original-index', originalIndex); 
                btn.className = '';
                btn.disabled = false; 
            });
        }
        function handleOptionClick(event) {
            if (event.target.tagName !== 'BUTTON') return;
            checkAnswer(event.target);
        }
        function checkAnswer(btn) {
            if (window.answeredCurrentQuestion) return; 
            const q = window.currentExercises[window.currentQ];
            const originalIndex = parseInt(btn.getAttribute('data-original-index'));
            const correctOriginalIndex = q.correct;
            window.answeredCurrentQuestion = true; 
            document.querySelectorAll('.options button').forEach(b => b.disabled = true);
            if (originalIndex === correctOriginalIndex) {
                btn.classList.add('correct');
                window.points++; 
                window.completedExercises.push(q.q);
            } else {
                btn.classList.add('wrong');
                document.querySelectorAll('.options button').forEach(b => {
                    if (parseInt(b.getAttribute('data-original-index')) === correctOriginalIndex) {
                        b.classList.add('correct');
                    }
                });
            }
            updatePoints(); 
            updateMedals();
            updateLevel(); 
        }
        function nextQuestion() {
            if (!window.answeredCurrentQuestion) {
                window.showCustomMessage('Debes responder la pregunta actual antes de avanzar.', 'info');
                return;
            }
            window.currentQ++;
            loadQuestion();
        }
        function updatePoints() {
            document.getElementById('pointsDisplay').innerText = `Puntos: ${window.points}`;
            const progress = Math.min((window.points % 10) * 10, 100); 
            document.getElementById('progress').style.width = progress + '%';
        }
        function updateLevel() {
            const oldLevel = window.level;
            const newLevel = Math.floor(window.points / 10) + 1; 
            if (newLevel > oldLevel) {
                window.level = newLevel;
                if(typeof window.saveStudyData === 'function') window.saveStudyData(); // Llamada al m√≥dulo
                document.getElementById('rewardMessage').style.display = 'block'; 
                document.getElementById('rewardLevel').innerText = window.level;
                setTimeout(startRewardGame, 1500); 
                if (window.level === 10) {
                    window.showCustomMessage("¬°Has alcanzado el nivel 10! ¬°Eres un campe√≥n del estudio!", 'success');
                }
            }
            document.getElementById('levelDisplay').innerText = `Nivel: ${window.level}`;
        }
        function updateMedals() {
            const container = document.getElementById('medals');
            container.innerHTML = '';
            const milestones = [5, 10, 20, 30, 40, 50];
            const completedCount = window.completedExercises.length;
            milestones.forEach(m => {
                const medal = document.createElement('div');
                medal.classList.add('medal');
                let icon = 'üèÖ';
                if (m === 5) icon = 'ü•â'; 
                if (m === 10) icon = 'ü•à'; 
                if (m === 20) icon = 'ü•á'; 
                if (m === 30) icon = 'üèÜ';
                if (m === 40) icon = 'üéñÔ∏è';
                if (m === 50) icon = 'üëë';
                medal.textContent = icon;
                if (completedCount >= m) medal.classList.add('active');
                container.appendChild(medal);
            });
        }
        function updateReviewScreen() {
            document.getElementById('finalPoints').innerText = window.points;
            document.getElementById('finalLevel').innerText = window.level;
            const reviewDiv = document.getElementById('reviewQuestions');
            reviewDiv.innerHTML = '';
            if (window.completedExercises.length === 0) {
                reviewDiv.innerHTML = '<p class="text-center text-gray-700">No acertaste ninguna pregunta en esta sesi√≥n. ¬°Sigue practicando!</p>';
                return;
            }
            window.completedExercises.forEach((q, i) => {
                const p = document.createElement('p');
                p.textContent = `${i + 1}. ${q}`;
                p.className = 'py-1 border-b border-green-200 text-green-700 font-medium';
                reviewDiv.appendChild(p);
            });
        }
        
        // --- Funciones de Premio (Juegos) ---
        function showGameContainer(containerId, iframeId, file) {
             document.querySelectorAll('.game-container').forEach(container => {
                 container.classList.remove('active');
             });
             document.getElementById(containerId).classList.add('active');
             // El src es un placeholder. En producci√≥n deber√≠a ser la URL real del juego.
             document.getElementById(iframeId).src = `https://placehold.co/600x400/28a745/white?text=${file} Cargar Juego`;
        }
        function startRewardGame() {
            showScreen('gameScreen');
            document.getElementById('rewardMessage').style.display = 'block';
            const gameIndex = Math.floor(Math.random() * availableGames.length);
            const selectedGame = availableGames[gameIndex];
            showGameContainer(selectedGame.container, selectedGame.iframe, selectedGame.name);
        }
        availableGames.forEach(game => {
            window[game.func] = () => {
                 showGameContainer(game.container, game.iframe, game.name);
            };
        });

        // --- Funciones Gestor de Tareas (Renderizado) ---
        function renderTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = ''; 
            if (window.currentTasks.length === 0) {
                taskList.innerHTML = '<p class="text-center text-gray-500">¬°No hay tareas pendientes! A√±ade una para empezar.</p>';
                return;
            }
            window.currentTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskDiv.setAttribute('data-id', task.id);
                const deadlineText = task.deadline ? new Date(task.deadline).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }) : 'Sin fecha';
                taskDiv.innerHTML = `
                    <div class="task-details flex-grow">
                        <p class="font-medium">${task.text}</p>
                        <p class="text-xs text-gray-500">Fecha l√≠mite: ${deadlineText}</p>
                    </div>
                    <div class="task-actions">
                        <button class="complete-btn" onclick="toggleTaskCompletion('${task.id}', ${!task.completed})" title="${task.completed ? 'Marcar como pendiente' : 'Marcar como completada'}">
                            ${task.completed ? 'üîÑ' : '‚úÖ'}
                        </button>
                        <button class="delete-btn" onclick="showTaskDeleteConfirmation('${task.id}')" title="Eliminar tarea">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                taskList.appendChild(taskDiv);
            });
        }
        function showTaskDeleteConfirmation(taskId) {
            window.showCustomMessage('¬øSeguro que quieres eliminar esta tarea? Esto no se puede deshacer.', 'error');
            const modalBtn = document.getElementById('customMessageModal').querySelector('.main-button');
            modalBtn.onclick = async () => {
                await window.deleteTask(taskId);
                hideCustomMessage();
            };
        }
        
        // --- Funciones Planificador Visual (Renderizado y manipulaci√≥n local) ---
        function addRoutineSlot() {
            const startTime = document.getElementById('routineStartTime').value;
            const activity = document.getElementById('routineActivity').value.trim();
            const duration = parseInt(document.getElementById('routineDuration').value);
            if (!startTime || !activity) {
                window.showCustomMessage('Debes especificar la hora de inicio y la actividad.', 'error');
                return;
            }
            const timeParts = startTime.split(':').map(Number);
            const sortKey = timeParts[0] * 60 + timeParts[1];
            window.currentRoutine.push({ startTime, activity, duration, sortKey });
            window.currentRoutine.sort((a, b) => a.sortKey - b.sortKey);
            renderRoutine();
            document.getElementById('routineActivity').value = '';
            document.getElementById('routineDuration').value = '60';
        }
        
        function renderRoutine() {
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            if (window.currentRoutine.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">A√±ade bloques de actividad para crear tu horario visual.</p>';
                return;
            }
            window.currentRoutine.forEach((slot, index) => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'schedule-slot';
                const [hour, minute] = slot.startTime.split(':').map(Number);
                const start = new Date(2000, 0, 1, hour, minute);
                const end = new Date(start.getTime() + slot.duration * 60000);
                const formatTime = (date) => date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
                const timeText = `${slot.startTime} - ${formatTime(end)}`;
                slotDiv.innerHTML = `
                    <div class="slot-time">${timeText}</div>
                    <div class="slot-activity">${slot.activity} (${slot.duration} min)</div>
                    <button onclick="removeRoutineSlot(${index})" class="delete-btn">üóëÔ∏è</button>
                `;
                container.appendChild(slotDiv);
            });
        }
        
        // Funci√≥n corregida: Ahora es AS√çNCRONA y llama a saveRoutine() para actualizar Firestore
        async function removeRoutineSlot(index) {
            window.currentRoutine.splice(index, 1);
            renderRoutine();
            // Guarda inmediatamente en Firestore para hacer el cambio permanente
            await window.saveRoutine(); 
            window.showCustomMessage('Bloque de rutina eliminado y guardado permanentemente.', 'success');
        }

        // Hacemos las funciones necesarias accesibles globalmente (solo las que se llaman desde el HTML)
        window.hideCustomMessage = hideCustomMessage;
        window.showScreen = showScreen;
        window.addRoutineSlot = addRoutineSlot;
        window.removeRoutineSlot = removeRoutineSlot;
        window.startExercises = startExercises;
        window.loadQuestion = loadQuestion;
        window.handleOptionClick = handleOptionClick;
        window.nextQuestion = nextQuestion;
        window.goToReview = goToReview;
        window.goToSubjectFromExercise = goToSubjectFromExercise;
        window.showTaskDeleteConfirmation = showTaskDeleteConfirmation;
        window.endGame = endGame;
        
    </script>
</body>
</html>
