<!DOCTYPE html>
<html>
<head>
    <title>CarlaMaths App - 1¬∫ESO (TDA Enhancements)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="module">
        // Importaciones de Firebase 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, deleteDoc, updateDoc, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACI√ìN DE FIREBASE (VARIABLES GLOBALES DEL ENTORNO) ---
        // Estas variables se proporcionan autom√°ticamente y son OBLIGATORIAS.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Aseguramos que el JSON sea parseado
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {}; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // setLogLevel('debug'); // √ötil para ver logs de Firestore

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.isAuthReady = false;
        window.userId = null;
        
        // Define las funciones de persistencia para hacerlas globales antes de que se ejecute el DOMContentLoaded
        window.loadStudyData = loadStudyData;
        window.loadTasks = loadTasks;
        window.loadRoutine = loadRoutine;

        // Funci√≥n para inicializar la autenticaci√≥n
        async function initializeAuthAndFirestore() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        window.isAuthReady = true;
                        // Una vez autenticado, cargar los datos de estudio, tareas y rutina
                        loadStudyData(); // Carga puntos/nivel y navega
                        loadTasks(); // Inicia el listener de tareas
                        loadRoutineFromDB(); // Carga la rutina
                    } else {
                        window.userId = null;
                        window.isAuthReady = true; // Listo, incluso si es an√≥nimo
                        showCustomMessage('Sesi√≥n no iniciada. Usando modo an√≥nimo. Tu progreso no se guardar√°.', 'info');
                        // Aseguramos que la pantalla de inicio se muestre si fall√≥ la carga
                        document.getElementById('sessionUserId').innerText = 'AN√ìNIMO';
                        hideAllScreens();
                        document.getElementById('loginScreen').classList.add('active');
                    }
                });
            } catch (error) {
                console.error("Error en la autenticaci√≥n:", error);
                showCustomMessage('Error al iniciar sesi√≥n. Int√©ntalo de nuevo.', 'error');
            }
        }

        // --- DEFINICI√ìN DE RUTAS (Collections) ---
        // Datos de estudio (puntos/nivel) - Privado
        window.getStudyDataPath = () => doc(window.db, `artifacts/${appId}/users/${window.userId}/study_data`, 'current_stats');
        // Tareas (Todoist-like) - Privado
        window.getTasksCollection = () => collection(window.db, `artifacts/${appId}/users/${window.userId}/tasks`);
        // Rutina (Tiimo-like) - Privado
        window.getRoutineDataPath = () => doc(window.db, `artifacts/${appId}/users/${window.userId}/routine_data`, 'daily_schedule');

        // Inicializar al cargar el script
        initializeAuthAndFirestore();

        // Para evitar problemas con el DOMContentLoaded en JS, iniciamos las poblaciones
        // solo despu√©s de que se cargue el DOM y Firebase est√© listo.
        document.addEventListener('DOMContentLoaded', () => {
             // Listener original
             document.getElementById('subjectChoose').addEventListener('change', populateEvaluations);
             document.getElementById('evaluationChoose').addEventListener('change', populateTopics);
        });

        // Hacemos las funciones necesarias accesibles globalmente desde el script principal (no module)
        window.showCustomMessage = showCustomMessage;
        window.hideCustomMessage = hideCustomMessage;
        window.showScreen = showScreen;
        window.deleteTask = deleteTask;
        window.toggleTaskCompletion = toggleTaskCompletion;
        window.loadRoutineFromDB = loadRoutineFromDB;


    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... Estilos CSS aqu√≠ (se omiten por brevedad en la respuesta) ... */
        body {
            font-family: 'Inter', Arial, sans-serif; /* Usamos Inter para un look moderno */
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
            text-align: center;
            touch-action: pan-y;
        }
        .screen {
            display: none;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 10px; /* Bordes redondeados */
            text-align: left;
        }
        .screen.active {
            display: block;
        }
        h2 {
            font-size: 1.8em;
            color: #4a7d4a; /* Tono verde oscuro */
            margin-bottom: 20px;
            text-align: center;
        }
        /* Estilos de la pantalla de Ejercicios */
        #exerciseScreen { background-color: #e6ffe6; text-align: center; } /* Verde claro */
        .question-box {
            background-color: #fff;
            border: 2px solid #5cb85c;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        /* COLORES DE BOTONES PARA MEJOR CONTRASTE */
        .options button, .main-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            background-color: #a4e4a4; 
            color: #333; 
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: 600;
        }
        .main-button {
            background-color: #5cb85c; /* Bot√≥n principal verde */
            color: white;
            box-shadow: 0 3px #3c8d3c;
        }
        .main-button:active {
            transform: translateY(2px);
            box-shadow: 0 1px #3c8d3c;
        }
        .options button:hover:not(:disabled) {
            background-color: #79d279; 
        }
        .options button.correct {
            background-color: #28a745; 
            color: white; 
            font-weight: bold;
        }
        .options button.wrong {
            background-color: #f17b7b; 
            color: #333; 
        }
        .options button:disabled {
            opacity: 0.7;
            cursor: default;
        }
        
        .gamification {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            border-bottom: 2px solid #ccc;
        }
        .progress-bar-container {
            width: 50%;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin: 0 10px;
            height: 20px;
        }
        #progress {
            height: 100%;
            width: 0%;
            background-color: #ffc107; 
            transition: width 0.5s;
        }
        .medal {
            font-size: 1.5em;
            opacity: 0.3;
        }
        .medal.active {
            opacity: 1;
        }
        .reward-banner {
            background-color: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 10;
            position: relative;
        }
        /* ESTILOS PARA LOS SELECTORES DE ASIGNATURA/EVALUACI√ìN/TEMA */
        .subject-select {
            display: block; 
            width: 100%; 
            padding: 10px 15px; 
            margin: 10px 0; 
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box; 
        }

        /* --- ESTILOS DE TAREAS (Todoist-like) --- */
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-left: 5px solid #007bff; /* Color de √©nfasis */
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .task-item.completed {
            background-color: #e0f7e0;
            border-left: 5px solid #28a745;
            text-decoration: line-through;
            opacity: 0.8;
        }
        .task-actions button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.2em;
        }
        .task-actions .delete-btn { color: #dc3545; }
        .task-actions .complete-btn { color: #28a745; }


        /* --- ESTILOS DE PLANIFICADOR VISUAL (Tiimo-like) --- */
        #scheduleContainer {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .schedule-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #fff0d6; /* Color c√°lido para el planificador */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid #ff9800;
        }
        .slot-time {
            font-weight: bold;
            color: #ff9800;
            width: 30%;
        }
        .slot-activity {
            flex-grow: 1;
            text-align: left;
        }

        /* ESTILOS DEL MODAL DE MENSAJE (Reemplaza a alert()) */
        #customMessageModal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        .modal-content p { margin-bottom: 20px; }


        /* Estilos Responsive */
        @media (max-width: 768px) {
            .screen {
                padding: 10px;
                box-shadow: none;
                border-radius: 0;
            }
            .gamification {
                flex-direction: column;
                gap: 5px;
            }
            .progress-bar-container {
                width: 100%;
                margin: 5px 0;
            }
            .task-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            .task-details {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen active">
        <h2>Bienvenido, Alex üëã</h2>
        <p>¬°Vamos a repasar 1¬∫ESO jugando!</p>
        <input type="text" id="studentNameLogin" placeholder="Tu Nombre" style="padding: 10px; margin: 10px 0; width: 80%; border-radius: 5px; border: 1px solid #ccc;">
        <input type="number" id="studentAgeLogin" placeholder="Tu Edad" style="padding: 10px; margin: 10px 0; width: 80%; border-radius: 5px; border: 1px solid #ccc;">
        <button onclick="goToSubjectFromLogin()" class="main-button">Entrar a la App</button>
        <p class="text-xs text-gray-500 mt-4 text-center">ID de Sesi√≥n: <span id="sessionUserId">Cargando...</span></p>
        <p class="text-xs text-gray-500 mt-2 text-center">Guarda este ID para compartir tu progreso.</p>

    </div>
    
    <div id="subjectScreen" class="screen">
        <h2>Men√∫ de Estudio</h2>
        <div class="mb-4">
            <button onclick="showScreen('exerciseScreen'); loadQuestion()" class="main-button" style="background-color: #5cb85c;">üöÄ Empezar a Estudiar</button>
            <button onclick="showScreen('taskManagerScreen')" class="main-button" style="background-color: #007bff; box-shadow: 0 3px #0056b3;">‚úÖ Mi Gestor de Tareas (Todoist)</button>
            <button onclick="showScreen('visualPlannerScreen'); loadRoutineFromDB();" class="main-button" style="background-color: #ff9800; box-shadow: 0 3px #e68a00;">üìÖ Mi Rutina Diaria (Tiimo)</button>
            <button onclick="showScreen('reviewScreen')" class="main-button" style="background-color: #6c757d; box-shadow: 0 3px #545b62;">üìà Revisar Progreso</button>
        </div>

        <h3>Selecciona tu Tema</h3>
        <select id="subjectChoose" class="subject-select">
            <option value="" disabled selected>-- Elige Asignatura --</option>
            <option value="Matem√°ticas">Matem√°ticas</option>
            <option value="Lengua">Lengua</option>
            <option value="Sociales">Sociales</option>
        </select>

        <select id="evaluationChoose" class="subject-select">
            <option value="">--Selecciona Evaluaci√≥n--</option>
        </select>

        <select id="topicChoose" class="subject-select">
            <option value="">--Selecciona Tema--</option>
        </select>

        <button onclick="startExercises()" class="main-button" style="background-color: #28a745;">Cargar Ejercicios</button>
    </div>

    <div id="exerciseScreen" class="screen">
        <div class="gamification">
            <span id="levelDisplay">Nivel: 1</span>
            <div class="progress-bar-container"><div id="progress"></div></div>
            <span id="pointsDisplay">Puntos: 0</span>
            <div id="medals"></div>
        </div>
        
        <p>Est√°s estudiando: <strong id="subjectTopic"></strong></p>
        <p>Pregunta <span id="questionNumber">1</span> de <span id="totalQuestions">20</span></p>

        <div class="question-box">
            <p id="questionText">Cargando pregunta...</p>
        </div>
        
        <div class="options" onclick="handleOptionClick(event)">
            <button data-option-index="0"></button>
            <button data-option-index="1"></button>
            <button data-option-index="2"></button>
            <button data-option-index="3"></button>
        </div>

        <button onclick="nextQuestion()" class="main-button">Siguiente Pregunta</button>
        <button onclick="goToReview()" class="main-button" style="background-color: #6c757d;">Terminar Sesi√≥n (Revisar)</button>
    </div>

    <div id="taskManagerScreen" class="screen">
        <h2 style="text-align: left;">‚úÖ Mis Asignaciones (Todoist-like)</h2>
        <div class="mb-6 p-4 bg-gray-100 rounded-lg">
            <input type="text" id="newTaskText" placeholder="Nueva tarea o asignaci√≥n (Ej: 'Hacer el resumen de Historia')" class="subject-select">
            <input type="date" id="newTaskDeadline" class="subject-select" title="Fecha L√≠mite">
            <button onclick="addTask()" class="main-button" style="background-color: #007bff; padding: 10px;">A√±adir Tarea</button>
        </div>

        <div id="taskList" class="flex flex-col gap-2">
            <p class="text-center text-gray-500" id="loadingTasks">Cargando tareas...</p>
        </div>

        <button onclick="showScreen('subjectScreen')" class="main-button mt-6" style="background-color: #333;">Volver al Men√∫</button>
    </div>
    
    <div id="visualPlannerScreen" class="screen">
        <h2 style="text-align: left;">üìÖ Mi Rutina Diaria (Tiimo-like)</h2>

        <div class="mb-6 p-4 bg-gray-100 rounded-lg">
            <p class="text-sm text-gray-600 mb-2">Define tu d√≠a: qu√© hacer y cu√°nto tiempo.</p>
            <input type="time" id="routineStartTime" value="09:00" class="subject-select inline-block w-1/2 pr-1" style="width: 49%; padding-right: 0;">
            <input type="text" id="routineActivity" placeholder="Actividad (Ej: 'Estudio de Matem√°ticas')" class="subject-select">
            <select id="routineDuration" class="subject-select">
                <option value="15">15 minutos</option>
                <option value="30">30 minutos</option>
                <option value="45">45 minutos</option>
                <option value="60" selected>1 hora (60 minutos)</option>
                <option value="90">1 hora y media</option>
            </select>
            <button onclick="addRoutineSlot()" class="main-button" style="background-color: #ff9800; padding: 10px;">A√±adir Bloque</button>
            <button onclick="saveRoutine()" class="main-button" style="background-color: #ff6f00; padding: 10px;">Guardar Rutina</button>
        </div>

        <h3>Tu Horario Visual</h3>
        <div id="scheduleContainer">
            <p class="text-center text-gray-500" id="loadingRoutine">A√±ade bloques de actividad.</p>
        </div>

        <button onclick="showScreen('subjectScreen')" class="main-button mt-6" style="background-color: #333;">Volver al Men√∫</button>
    </div>


    <div id="reviewScreen" class="screen">
        <h2 style="text-align: center;">üìà Resumen de la Sesi√≥n</h2>
        <div class="p-4 bg-yellow-100 rounded-lg mb-6 text-center">
            <p class="text-lg font-bold text-yellow-800">Puntos Totales: <span id="finalPoints" class="text-2xl">0</span></p>
            <p class="text-lg font-bold text-yellow-800">Nivel Alcanzado: <span id="finalLevel" class="text-2xl">1</span></p>
        </div>
        
        <h3>Ejercicios Acertados:</h3>
        <div id="reviewQuestions" class="mt-4 p-4 border rounded-lg bg-gray-50">
            </div>

        <button onclick="goToSubjectFromExercise()" class="main-button mt-6" style="background-color: #5cb85c;">Volver al Men√∫</button>
    </div>

    <div id="gameScreen" class="screen">
        <div id="rewardMessage" class="reward-banner" style="display: none;">
            <h2>¬°FELICIDADES, Alex! ¬°PREMIO! üéâ</h2>
            <p>Has subido al Nivel <span id="rewardLevel"></span>. T√≥mate un descanso y ¬°a jugar!</p>
        </div>

        <div id="arkanoidGameContainer" class="game-container"> <h2>ArKanoid T√°ctil</h2> <iframe id="iframe_arkanoid" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div> 
        <div id="memoriaGameContainer" class="game-container"> <h2>Juego de Pares</h2> <iframe id="iframe_memoria" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div>
        <div id="matamarcianosGameContainer" class="game-container"> <h2>Matamarcianos</h2> <iframe id="iframe_matamarcianos" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div>
        <div id="asteroidesGameContainer" class="game-container"> <h2>Juego de Asteroides</h2> <iframe id="iframe_asteroides" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div>
        <div id="donkeykongGameContainer" class="game-container"> <h2>Donkeykong</h2> <iframe id="iframe_donkeykong" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div>
        <div id="froggerGameContainer" class="game-container"> <h2>Juego de la Rana</h2> <iframe id="iframe_frogger" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div>
        <div id="pongGameContainer" class="game-container"> <h2>Tenis</h2> <iframe id="iframe_pong" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div>
        <div id="tictactoeGameContainer" class="game-container"> <h2>Tres en Raya</h2> <iframe id="iframe_tictactoe" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div> 
        <div id="tetrisGameContainer" class="game-container"> <h2>Tetris Lite</h2> <iframe id="iframe_tetris" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div>
        <div id="pacmanGameContainer" class="game-container"> <h2>Pacman</h2> <iframe id="iframe_pacman" src="" frameborder="0" scrolling="no" allowfullscreen></iframe> </div>
        
        <div style="margin-top: 20px;">
            <button onclick="endGame()" class="main-button" style="background-color: #dc3545;">Volver a los Ejercicios</button>
        </div>
    </div>
    
    <div id="customMessageModal">
        <div class="modal-content">
            <p id="customMessageText"></p>
            <button onclick="hideCustomMessage()" class="main-button" style="background-color: #5cb85c; width: auto; padding: 8px 20px;">Entendido</button>
        </div>
    </div>


    <script>
        // ===================================================================
        // 1. VARIABLES GLOBALES DE ESTADO
        // ===================================================================
        let currentExercises = [];
        let currentQ = 0;
        let points = 0;
        let level = 1;
        let completedExercises = []; // Preguntas acertadas en la sesi√≥n actual
        let answeredCurrentQuestion = false;
        let currentRoutine = [];
        let currentTasks = [];
        let animationFrameId = null; 

        // Lista de juegos disponibles con sus contenedores y archivos
        const availableGames = [
            { id: 1, name: "Arkanoid T√°ctil", func: "startGame1_Arkanoid", file: "arkanoid.html", container: "arkanoidGameContainer", iframe: "iframe_arkanoid" },
            { id: 2, name: "Juego de Pares", func: "startGame2_Memoria", file: "memoria.html", container: "memoriaGameContainer", iframe: "iframe_memoria" },
            { id: 3, name: "Matamarcianos", func: "startGame3_Matamarcianos", file: "matamarcianos.html", container: "matamarcianosGameContainer", iframe: "iframe_matamarcianos" },
            { id: 4, name: "Juego de Asteroides", func: "startGame4_Asteroides", file: "asteroides.html", container: "asteroidesGameContainer", iframe: "iframe_asteroides" },
            { id: 5, name: "Donkeykong", func: "startGame5_Donkeykong", file: "donkeykong.html", container: "donkeykongGameContainer", iframe: "iframe_donkeykong" },
            { id: 6, name: "Juego de la Rana", func: "startGame6_Frogger", file: "frogger.html", container: "froggerGameContainer", iframe: "iframe_frogger" },
            { id: 7, name: "Tenis", func: "startGame7_Pong", file: "pong.html", container: "pongGameContainer", iframe: "iframe_pong" },
            { id: 8, name: "Tres en Raya", func: "startGame8_TicTacToe", file: "tictactoe.html", container: "tictactoeGameContainer", iframe: "iframe_tictactoe" },
            { id: 9, name: "Tetris Lite", func: "startGame9_Tetris", file: "tetris.html", container: "tetrisGameContainer", iframe: "iframe_tetris" },
            { id: 10, name: "Pacman", func: "startGame10_Pacman", file: "pacman.html", container: "pacmanGameContainer", iframe: "iframe_pacman" }
        ];

        // ===================================================================
        // 2. ESTRUCTURA CURRICULAR (EJEMPLO COMPLETO)
        // ===================================================================
        const curriculum = {
            "Matem√°ticas": {
                "1¬∫ESO": {
                    "1¬™ evaluaci√≥n": {
                        "N√∫meros y Operaciones": [
                            { q: "¬øC√≥mo se lee 1.345.000?", options: ["Un mill√≥n trescientos cuarenta y cinco mil", "Trece millones", "Ciento treinta y cuatro mil", "Un bill√≥n"], correct: 0 },
                            // Se asume que el resto del curr√≠culum va aqu√≠...
                            { q: "¬øQu√© es un n√∫mero primo?", options: ["Un n√∫mero que solo es divisible por 1 y por s√≠ mismo", "Un n√∫mero divisible por 2", "Un n√∫mero mayor que 10", "Un n√∫mero que termina en 5"], correct: 0 }
                        ],
                        "Geometr√≠a B√°sica": [
                             { q: "¬øCu√°ntos lados tiene un hex√°gono?", options: ["Cinco", "Seis", "Ocho", "Cuatro"], correct: 1 }
                        ]
                    },
                     "2¬™ evaluaci√≥n": {
                        "Fracciones": [
                             { q: "¬øCu√°l es la fracci√≥n irreducible de 4/8?", options: ["1/4", "1/2", "2/4", "3/8"], correct: 1 }
                        ]
                    }
                }
            },
            "Lengua": {
                "1¬∫ESO": {
                    "1¬™ evaluaci√≥n": {
                        "Clases de palabras": [
                            { q: "¬øQu√© clase de palabra es 'r√°pido'?", options: ["Sustantivo", "Verbo", "Adjetivo", "Adverbio"], correct: 2 }
                        ]
                    }
                }
            },
            "Sociales": {
                "1¬∫ESO": {
                    "1¬™ evaluaci√≥n": {
                        "La Tierra": [
                            { q: "¬øQui√©n realiz√≥ la primera vuelta al mundo por mar?", options: ["Crist√≥bal Col√≥n", "Magallanes", "Vasco da Gama", "Hern√°n Cort√©s"], correct: 1 }
                        ]
                    }
                }
            }
        };

        // ===================================================================
        // 3. FUNCIONES DE MENSAJES (Reemplazo de alert())
        // ===================================================================

        function showCustomMessage(message, type = 'error') {
            const modal = document.getElementById('customMessageModal');
            const messageText = document.getElementById('customMessageText');
            const colorMap = {
                error: '#dc3545',
                info: '#007bff',
                success: '#28a745'
            };

            messageText.innerText = message;
            // Estilizar seg√∫n el tipo de mensaje
            modal.querySelector('.modal-content').style.border = `2px solid ${colorMap[type] || colorMap.error}`;
            modal.style.display = 'block';
        }

        function hideCustomMessage() {
            document.getElementById('customMessageModal').style.display = 'none';
        }


        // ===================================================================
        // 4. FUNCIONES DE FIREBASE / PERSISTENCIA
        // ===================================================================
        
        // Carga los puntos/nivel desde Firestore
        async function loadStudyData() {
            if (!window.isAuthReady || !window.userId) return;
            try {
                const docRef = window.getStudyDataPath();
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    points = data.points || 0;
                    level = data.level || 1;
                    
                    // Aseguramos que los displays se actualicen
                    updatePoints();
                    updateLevel(); // Llama a la l√≥gica de actualizaci√≥n, pero no deber√≠a subir de nivel solo por cargar
                    updateMedals(); 
                }
            } catch (e) {
                console.error("Error al cargar datos de estudio:", e);
            } finally {
                // Actualiza el ID de sesi√≥n
                document.getElementById('sessionUserId').innerText = window.userId || 'No disponible';
                document.getElementById('loadingTasks').innerText = 'A√±ade tus tareas para empezar.';

                // Navegar a la pantalla de selecci√≥n de tema
                hideAllScreens();
                document.getElementById('subjectScreen').classList.add('active'); // Navegar a subjectScreen directamente
            }
        }

        // Guarda los puntos/nivel en Firestore
        async function saveStudyData() {
            if (!window.isAuthReady || !window.userId) return;
            try {
                const docRef = window.getStudyDataPath();
                await setDoc(docRef, { 
                    points: points, 
                    level: level, 
                    last_update: new Date().toISOString() 
                }, { merge: true });
            } catch (e) {
                console.error("Error al guardar datos de estudio:", e);
            }
        }


        // ===================================================================
        // 5. NAVEGACI√ìN Y SELECTORES
        // ===================================================================

        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        }

        function showScreen(screenId) {
             hideAllScreens();
             document.getElementById(screenId).classList.add('active');
             // Si volvemos al men√∫, aseguramos que la lista de temas est√© actualizada
             if (screenId === 'subjectScreen') {
                 populateEvaluations();
             }
        }

        function goToSubjectFromLogin() {
            const name = document.getElementById('studentNameLogin').value.trim();
            const age = document.getElementById('studentAgeLogin').value.trim();
            
            if (!name || !age) {
                showCustomMessage('Introduce tu nombre y edad.', 'error');
                return;
            }
            // Navegar al men√∫ principal y esperar a que Firebase cargue datos
            // La navegaci√≥n real se hace en loadStudyData (llamada por initializeAuthAndFirestore)
            // Si ya carg√≥, navegamos. Si no, esperamos a que el listener de Auth lo haga.
            if (window.isAuthReady) {
                 showScreen('subjectScreen');
            } else {
                 showCustomMessage('Cargando sesi√≥n...', 'info');
            }
        }
        
        function goToSubjectFromExercise() {
            showScreen('subjectScreen');
        }

        function goToReview() {
            showScreen('reviewScreen');
            updateReviewScreen();
        }

        // Ya a√±adido en el script module:
        // document.getElementById('subjectChoose').addEventListener('change', populateEvaluations);
        // document.getElementById('evaluationChoose').addEventListener('change', populateTopics);


        function populateEvaluations() {
            const subjectChosen = document.getElementById('subjectChoose').value; 
            const evaluationSelect = document.getElementById('evaluationChoose');
            evaluationSelect.innerHTML = '<option value="">--Selecciona Evaluaci√≥n--</option>';
            
            if (!subjectChosen) {
                populateTopics();
                return;
            }
            
            // Aseguramos que solo buscamos en 1¬∫ESO, seg√∫n la estructura
            const currentCurriculum = curriculum[subjectChosen] ? curriculum[subjectChosen]['1¬∫ESO'] : {};
            
            Object.keys(currentCurriculum).forEach(evalName => {
                const o = document.createElement('option');
                o.value = evalName;
                o.text = evalName;
                evaluationSelect.add(o);
            });

            populateTopics(); 
        }

        function populateTopics() {
            const subject = document.getElementById('subjectChoose').value;
            const evaluation = document.getElementById('evaluationChoose').value;
            const topicSelect = document.getElementById('topicChoose');
            topicSelect.innerHTML = '<option value="">--Selecciona Tema--</option>';

            if (subject && evaluation && curriculum[subject]["1¬∫ESO"][evaluation]) {
                Object.keys(curriculum[subject]["1¬∫ESO"][evaluation]).forEach(t => {
                    const o = document.createElement('option');
                    o.value = t;
                    o.text = t;
                    topicSelect.add(o);
                });
            }
        }

        function endGame() {
            // 1. Detener cualquier animaci√≥n de juego 
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            // 2. Ocultar todos los contenedores de juego
            document.querySelectorAll('.game-container').forEach(container => {
                container.classList.remove('active');
            });

            // 3. Ocultar la pancarta de felicitaci√≥n
            document.getElementById('rewardMessage').style.display = 'none'; 

            // 4. Volver a la pantalla de ejercicios y avanzar a la siguiente pregunta
            showScreen('exerciseScreen');
            answeredCurrentQuestion = true; 
            nextQuestion(); 
        }

        // ===================================================================
        // 6. FUNCIONES DE EJERCICIO Y GAMIFICACI√ìN
        // ===================================================================

        function startExercises() {
            const subject = document.getElementById('subjectChoose').value;
            const evaluation = document.getElementById('evaluationChoose').value;
            const topic = document.getElementById('topicChoose').value;

            if (!subject || !evaluation || !topic) {
                showCustomMessage('Selecciona asignatura, evaluaci√≥n y tema', 'error');
                return;
            }

            const original = curriculum[subject]["1¬∫ESO"][evaluation][topic];
            // L√≥gica para mezclar y limitar preguntas
            const shuffled = [...original];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }

            const maxQuestions = 100; // L√≠mite m√°ximo para la sesi√≥n
            currentExercises = shuffled.slice(0, Math.min(original.length, maxQuestions));

            currentQ = 0;
            completedExercises = [];
            answeredCurrentQuestion = false;

            showScreen('exerciseScreen');
            document.getElementById('subjectTopic').innerText = `${subject} - ${topic}`;
            document.getElementById('totalQuestions').innerText = currentExercises.length;
            
            updatePoints();
            updateLevel();
            updateMedals();
            loadQuestion();
        }

        function loadQuestion() {
            answeredCurrentQuestion = false;
            if (currentQ >= currentExercises.length) {
                return goToReview(); 
            }

            const q = currentExercises[currentQ];
            document.getElementById('questionNumber').innerText = currentQ + 1;
            document.getElementById('questionText').innerText = q.q;

            const btns = document.querySelectorAll('.options button');
            // Mezclar opciones
            const optionIndexes = [0, 1, 2, 3].sort(() => Math.random() - 0.5); 
            
            btns.forEach((btn, i) => {
                const originalIndex = optionIndexes[i];
                btn.innerText = q.options[originalIndex];
                btn.setAttribute('data-original-index', originalIndex); // Guardamos el √≠ndice original
                btn.className = '';
                btn.disabled = false; 
            });
        }

        function handleOptionClick(event) {
            if (event.target.tagName !== 'BUTTON') return;
            checkAnswer(event.target);
        }

        function checkAnswer(btn) {
            if (answeredCurrentQuestion) return; 

            const q = currentExercises[currentQ];
            const originalIndex = parseInt(btn.getAttribute('data-original-index'));
            const correctOriginalIndex = q.correct;

            answeredCurrentQuestion = true; 
            
            document.querySelectorAll('.options button').forEach(b => b.disabled = true);

            if (originalIndex === correctOriginalIndex) {
                btn.classList.add('correct');
                points++; 
                completedExercises.push(q.q);
                // Si la respuesta es correcta, buscamos el bot√≥n original correcto y lo marcamos
            } else {
                btn.classList.add('wrong');
                // Si fall√≥, buscamos el bot√≥n que conten√≠a la respuesta correcta y lo marcamos tambi√©n
                document.querySelectorAll('.options button').forEach(b => {
                    if (parseInt(b.getAttribute('data-original-index')) === correctOriginalIndex) {
                        b.classList.add('correct');
                    }
                });
            }
            
            updatePoints(); 
            updateMedals();
            updateLevel(); // Esta funci√≥n llama a saveStudyData y startRewardGame si sube de nivel
        }

        function nextQuestion() {
            if (!answeredCurrentQuestion) {
                showCustomMessage('Debes responder la pregunta actual antes de avanzar.', 'info');
                return;
            }
            currentQ++;
            loadQuestion();
        }

        function updatePoints() {
            document.getElementById('pointsDisplay').innerText = `Puntos: ${points}`;
            const progress = Math.min((points % 10) * 10, 100); 
            document.getElementById('progress').style.width = progress + '%';
        }

        function updateLevel() {
            if (currentExercises.length === 0 && points === 0) {
                document.getElementById('levelDisplay').innerText = `Nivel: ${level}`;
                return; 
            }

            const newLevel = Math.floor(points / 10) + 1; 
            if (newLevel > level) {
                level = newLevel;
                saveStudyData(); // Guardar el nuevo nivel inmediatamente
                
                // Mostrar la pancarta y comenzar el juego de recompensa
                document.getElementById('rewardMessage').style.display = 'block'; 
                document.getElementById('rewardLevel').innerText = level;
                
                setTimeout(startRewardGame, 1500); // Retraso para que vea el mensaje
                
                if (level === 10) {
                    showCustomMessage("¬°Has alcanzado el nivel 10! ¬°Eres un campe√≥n del estudio!", 'success');
                }
            }
            document.getElementById('levelDisplay').innerText = `Nivel: ${level}`;
        }

        function updateMedals() {
            const container = document.getElementById('medals');
            container.innerHTML = '';
            const milestones = [5, 10, 20, 30, 40, 50];
            const completedCount = completedExercises.length;

            milestones.forEach(m => {
                const medal = document.createElement('div');
                medal.classList.add('medal');
                
                let icon = 'üèÖ';
                if (m === 5) icon = 'ü•â'; 
                if (m === 10) icon = 'ü•à'; 
                if (m === 20) icon = 'ü•á'; 
                if (m === 30) icon = 'üèÜ';
                if (m === 40) icon = 'üéñÔ∏è';
                if (m === 50) icon = 'üëë';

                medal.textContent = icon;
                if (completedCount >= m) medal.classList.add('active');
                container.appendChild(medal);
            });
        }

        function updateReviewScreen() {
            document.getElementById('finalPoints').innerText = points;
            document.getElementById('finalLevel').innerText = level;

            const reviewDiv = document.getElementById('reviewQuestions');
            reviewDiv.innerHTML = '';
            if (completedExercises.length === 0) {
                reviewDiv.innerHTML = '<p class="text-center text-gray-700">No acertaste ninguna pregunta en esta sesi√≥n. ¬°Sigue practicando!</p>';
                return;
            }
            completedExercises.forEach((q, i) => {
                const p = document.createElement('p');
                p.textContent = `${i + 1}. ${q}`;
                p.className = 'py-1 border-b border-green-200 text-green-700 font-medium';
                reviewDiv.appendChild(p);
            });
        }
        
        // ===================================================================
        // 7. FUNCIONES DE PREMIO (JUEGOS PLACEHOLDERS)
        // ===================================================================

        // Funci√≥n auxiliar para mostrar el contenedor de juego
        function showGameContainer(containerId, iframeId, file) {
             document.querySelectorAll('.game-container').forEach(container => {
                 container.classList.remove('active');
             });
             document.getElementById(containerId).classList.add('active');
             // Cargar el juego en el iframe (Usamos un placeholder por ahora)
             document.getElementById(iframeId).src = `https://placehold.co/600x400/28a745/white?text=${file} Cargar Juego`;
        }

        function startRewardGame() {
            showScreen('gameScreen');

            // Oculta la pancarta de felicitaci√≥n (para que solo se muestre una vez)
            document.getElementById('rewardMessage').style.display = 'block';
            
            // L√≥gica para seleccionar un juego aleatorio
            const gameIndex = Math.floor(Math.random() * availableGames.length);
            const selectedGame = availableGames[gameIndex];

            // Ya no necesitamos window[selectedGame.func] si usamos showGameContainer
            // Simplemente mostramos el placeholder para el juego seleccionado
            showGameContainer(selectedGame.container, selectedGame.iframe, selectedGame.name);
        }

        // Placeholders para las funciones de juego (obligatorio para evitar errores)
        availableGames.forEach(game => {
            window[game.func] = () => {
                 showGameContainer(game.container, game.iframe, game.name);
            };
        });

        // ===================================================================
        // 8. FUNCIONES GESTOR DE TAREAS (Todoist-like)
        // ===================================================================

        // Carga tareas desde Firestore (Listener en tiempo real)
        function loadTasks() {
            if (!window.isAuthReady || !window.userId) return;
            
            const tasksCol = window.getTasksCollection();
            // Ordenamos por fecha l√≠mite y luego por completado (los no completados primero)
            const q = query(tasksCol, orderBy("completed", "asc"), orderBy("deadline", "asc"));
            
            onSnapshot(q, (snapshot) => {
                currentTasks = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    currentTasks.push({
                        id: doc.id,
                        text: data.text,
                        deadline: data.deadline,
                        completed: data.completed
                    });
                });
                renderTasks();
            }, (error) => {
                console.error("Error al escuchar las tareas:", error);
                document.getElementById('loadingTasks').innerText = 'Error al cargar tareas.';
            });
        }

        // Renderiza las tareas en la UI
        function renderTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = ''; 
            
            if (currentTasks.length === 0) {
                taskList.innerHTML = '<p class="text-center text-gray-500">¬°No hay tareas pendientes! A√±ade una para empezar.</p>';
                return;
            }

            currentTasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskDiv.setAttribute('data-id', task.id);

                const deadlineText = task.deadline ? new Date(task.deadline).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }) : 'Sin fecha';
                
                taskDiv.innerHTML = `
                    <div class="task-details flex-grow">
                        <p class="font-medium">${task.text}</p>
                        <p class="text-xs text-gray-500">Fecha l√≠mite: ${deadlineText}</p>
                    </div>
                    <div class="task-actions">
                        <button class="complete-btn" onclick="toggleTaskCompletion('${task.id}', ${!task.completed})" title="${task.completed ? 'Marcar como pendiente' : 'Marcar como completada'}">
                            ${task.completed ? 'üîÑ' : '‚úÖ'}
                        </button>
                        <button class="delete-btn" onclick="showTaskDeleteConfirmation('${task.id}')" title="Eliminar tarea">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                taskList.appendChild(taskDiv);
            });
        }
        
        // Funci√≥n para mostrar confirmaci√≥n de borrado
        function showTaskDeleteConfirmation(taskId) {
            // Reemplaza a window.confirm()
            showCustomMessage('¬øSeguro que quieres eliminar esta tarea? Esto no se puede deshacer.', 'error');
            // Modificamos el bot√≥n para que ejecute la eliminaci√≥n si se presiona.
            const modalBtn = document.getElementById('customMessageModal').querySelector('.main-button');
            modalBtn.onclick = async () => {
                await deleteTask(taskId);
                hideCustomMessage();
            };
        }


        // A√±ade una nueva tarea
        async function addTask() {
            if (!window.isAuthReady || !window.userId) {
                showCustomMessage('Espera a que la sesi√≥n est√© lista para a√±adir tareas.', 'info');
                return;
            }
            const text = document.getElementById('newTaskText').value.trim();
            const deadline = document.getElementById('newTaskDeadline').value; // Formato YYYY-MM-DD
            
            if (!text) {
                showCustomMessage('El texto de la tarea no puede estar vac√≠o.', 'error');
                return;
            }
            
            try {
                const tasksCol = window.getTasksCollection();
                await addDoc(tasksCol, {
                    text: text,
                    // Guardamos la fecha l√≠mite como string (YYYY-MM-DD) para f√°cil ordenaci√≥n
                    deadline: deadline, 
                    completed: false,
                    // Guardamos la fecha de creaci√≥n para un ordenamiento secundario si es necesario
                    createdAt: new Date().toISOString() 
                });
                document.getElementById('newTaskText').value = '';
                document.getElementById('newTaskDeadline').value = '';
                showCustomMessage('Tarea a√±adida con √©xito.', 'success');
            } catch (e) {
                console.error("Error al a√±adir tarea:", e);
                showCustomMessage('Error al a√±adir tarea.', 'error');
            }
        }

        // Marca/Desmarca una tarea como completada
        async function toggleTaskCompletion(taskId, completedStatus) {
            if (!window.isAuthReady || !window.userId) return;
            try {
                const taskRef = doc(window.getTasksCollection(), taskId);
                await updateDoc(taskRef, { completed: completedStatus });
            } catch (e) {
                console.error("Error al actualizar tarea:", e);
                showCustomMessage('Error al actualizar tarea.', 'error');
            }
        }

        // Elimina una tarea
        async function deleteTask(taskId) {
            if (!window.isAuthReady || !window.userId) return;

            try {
                const taskRef = doc(window.getTasksCollection(), taskId);
                await deleteDoc(taskRef);
            } catch (e) {
                console.error("Error al eliminar tarea:", e);
                showCustomMessage('Error al eliminar tarea.', 'error');
            }
        }
        
        // ===================================================================
        // 9. FUNCIONES PLANIFICADOR VISUAL (Tiimo-like)
        // ===================================================================

        // Inicializa la rutina al cargar la app (el listener inicial lo maneja el script module)
        // document.addEventListener('DOMContentLoaded', loadRoutine); // Ya no es necesario aqu√≠

        // Carga la rutina desde Firestore
        async function loadRoutineFromDB() {
            if (!window.isAuthReady || !window.userId) return;
            try {
                const docRef = window.getRoutineDataPath();
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    currentRoutine = docSnap.data().schedule || [];
                } else {
                    currentRoutine = []; // Inicializar si no existe
                }
                renderRoutine();
            } catch (e) {
                console.error("Error al cargar rutina:", e);
                document.getElementById('loadingRoutine').innerText = 'Error al cargar rutina.';
            }
        }

        // A√±ade un bloque de actividad a la rutina local
        function addRoutineSlot() {
            const startTime = document.getElementById('routineStartTime').value;
            const activity = document.getElementById('routineActivity').value.trim();
            const duration = parseInt(document.getElementById('routineDuration').value);

            if (!startTime || !activity) {
                showCustomMessage('Debes especificar la hora de inicio y la actividad.', 'error');
                return;
            }

            // Parsear hora para facilitar la ordenaci√≥n
            const timeParts = startTime.split(':').map(Number);
            const sortKey = timeParts[0] * 60 + timeParts[1];

            currentRoutine.push({ startTime, activity, duration, sortKey });
            // Ordenar por hora de inicio
            currentRoutine.sort((a, b) => a.sortKey - b.sortKey);
            
            renderRoutine();
            // Limpiar campos despu√©s de a√±adir
            document.getElementById('routineActivity').value = '';
            document.getElementById('routineDuration').value = '60';
        }

        // Guarda la rutina en Firestore
        async function saveRoutine() {
            if (!window.isAuthReady || !window.userId) {
                showCustomMessage('Espera a que la sesi√≥n est√© lista para guardar la rutina.', 'info');
                return;
            }
            try {
                const docRef = window.getRoutineDataPath();
                // Guardamos solo el array de horarios
                await setDoc(docRef, { schedule: currentRoutine }); 
                showCustomMessage('Rutina diaria guardada con √©xito.', 'success');
            } catch (e) {
                console.error("Error al guardar rutina:", e);
                showCustomMessage('Error al guardar rutina.', 'error');
            }
        }

        // Renderiza la rutina visualmente (Tiimo-like)
        function renderRoutine() {
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';

            if (currentRoutine.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">A√±ade bloques de actividad para crear tu horario visual.</p>';
                return;
            }

            currentRoutine.forEach((slot, index) => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'schedule-slot';

                // Calcular hora de finalizaci√≥n
                const [hour, minute] = slot.startTime.split(':').map(Number);
                const start = new Date(2000, 0, 1, hour, minute);
                const end = new Date(start.getTime() + slot.duration * 60000);
                
                const formatTime = (date) => date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
                
                const timeText = `${slot.startTime} - ${formatTime(end)}`;

                slotDiv.innerHTML = `
                    <div class="slot-time">${timeText}</div>
                    <div class="slot-activity">${slot.activity} (${slot.duration} min)</div>
                    <button onclick="removeRoutineSlot(${index})" class="delete-btn">üóëÔ∏è</button>
                `;
                container.appendChild(slotDiv);
            });
        }

        // Elimina un bloque de la rutina local
        function removeRoutineSlot(index) {
            currentRoutine.splice(index, 1);
            renderRoutine();
            showCustomMessage('Bloque de rutina eliminado. No olvides hacer clic en "Guardar Rutina" si deseas guardar este cambio permanentemente.', 'info');
        }

        // ===================================================================
        // 10. INICIO
        // ===================================================================

        // El inicio de la aplicaci√≥n est√° controlado por el script de Firebase
        // que llama a loadStudyData() al finalizar la autenticaci√≥n.

    </script>
</body>
</html>
